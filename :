// Post to get a new borrow
// delete to remove one 
// get to get all borrow by a person

import { Router } from "express";
import { db } from "../database";
const router = Router();

// Define a GET route to fetch book information
router.get('/:username', async function(req, res) {
    const response = await db.selectFrom('person').leftJoin("books", "books.borrower_id", "person.id").where('person.id','=', req.params.username).selectAll().executeTakeFirst()

    res.send(response)
})

router.post('/add', async function(req, res) {
    // verify json content
    const body = req.body

    if (!body.isbn || !body.userId) {
        res.status(400).send({message: "Missing required fields"})
        return
    }

    // save to database
    db.updateTable('books').set({ borrower_id: body.userId }).where('isbn', '=', body.isbn).execute()
        .then(x => res.send({messae: "Book Borrowed"}))
        .catch(x => {
            res.status(500).send({message: "Error borrowing book"})
        }
    )
})

router.post('/return', async function(req, res) {
    // verify json content
    const body = req.body
    // check if the book is borrowed by the user
    
    db.selectFrom('books').where('isbn', '=', body.isbn).select("borrower_id").executeTakeFirst()

    if (!body.isbn || !body.userId) {
        res.status(400).send({message: "Missing required fields"})
        return
    }

    // save to database
    db.updateTable('books').set({ borrower_id: body.userId }).where('isbn', '=', body.isbn).execute()
        .then(x => res.send({messae: "Book Borrowed"}))
        .catch(x => {
            res.status(500).send({message: "Error borrowing book"})
        }
    )
})


export default router;
